# Contributor: Evan Hazlett <ejhazlett@gmail.com>
# Maintainer: Evan Hazlett <ejhazlett@gmail.com>

pkgname=containerd-terra

# NOTE: containerd's Makefile tries to get REVISION from git, but we're building from a tarball.
_commit=ec661e8ceb85bca68cd759f9d9513cb6f103ca42
pkgver=1.3.0
pkgrel=1
pkgdesc="An open and reliable container runtime"
url="https://containerd.io"
arch="all"
license="Apache-2.0"
depends="runc"
install="$pkgname.post-install $pkgname.post-uninstall"
makedepends="btrfs-progs-dev go go-md2man libseccomp-dev"
subpackages="$pkgname-doc"
source="containerd-$_commit.tar.gz::https://github.com/containerd/containerd/archive/$_commit.tar.gz"
builddir="$srcdir/src/github.com/containerd/containerd"

build() {
	cd "$srcdir"
	export GOPATH="$PWD"
	mkdir -p $(dirname "$builddir")
        mv "$srcdir/containerd-$_commit" "$builddir"
	cd "$builddir"
	make VERSION="v$pkgver" REVISION="$_commit"
	# new generated manpages
	make genman
	# older non-generated manpages
	make MANPAGES="containerd-config.1 containerd-config.toml.5" man
}

check() {
	./bin/containerd --version
}

package() {
	install -d "$pkgdir"/usr/bin/
	install -Dsm755 "$builddir"/bin/* "$pkgdir"/usr/bin/
	install -d "$pkgdir"/usr/share/man/man1/
	install -Dm644 "$builddir"/man/*.1 "$pkgdir"/usr/share/man/man1/
	install -d "$pkgdir"/usr/share/man/man5/
	install -Dm644 "$builddir"/man/*.5 "$pkgdir"/usr/share/man/man5/
}
sha512sums="27915cc05f09cf708e943c8a52e439af4581d176bfe3ea74f108b944343179bae96709eee3c5ba787894202c50cdbbcd8e50bd7ae2ad42d6253e42a3821c35e0  containerd-ec661e8ceb85bca68cd759f9d9513cb6f103ca42.tar.gz"
